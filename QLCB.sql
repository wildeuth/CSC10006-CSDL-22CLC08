create database QLCB
go
use QLCB
go

CREATE TABLE PHANCONG (
	MANV nvarchar (15)  NOT NULL ,
	NGAYDI smalldatetime NOT NULL ,
	MACB nvarchar (3)  NOT NULL 
) 
GO

CREATE TABLE CHUYENBAY (
	MACB nvarchar (3)  NOT NULL ,
	SBDI nvarchar (3)  NULL ,
	SBDEN nvarchar (3)  NULL ,
	GIODI smalldatetime NULL ,
	GIODEN smalldatetime NULL 
) 
GO

CREATE TABLE KHACHHANG (
	MAKH nvarchar (15) NOT NULL,
	TEN nvarchar (15)  NULL ,
	DCHI nvarchar (50)  NULL ,
	DTHOAI nvarchar (15)  NULL 
) 
GO

CREATE TABLE DATCHO (
	MAKH nvarchar (15)  NOT NULL ,
	NGAYDI smalldatetime NOT NULL ,
	MACB nvarchar (3)  NOT NULL 
) 
GO

CREATE TABLE KHANANG (
	MANV nvarchar (15)  NOT NULL ,
	MALOAI nvarchar (15)  NOT NULL 
) 
GO

CREATE TABLE LICHBAY (
	NGAYDI smalldatetime NOT NULL ,
	MACB nvarchar (3)  NOT NULL ,
	SOHIEU smallint NULL ,
	MALOAI nvarchar (15)  NULL 
) 
GO

CREATE TABLE LOAIMB (
	HANGSX nvarchar (15)  NULL ,
	MALOAI nvarchar (15)  NOT NULL 
) 
GO

CREATE TABLE MAYBAY (
	SOHIEU smallint NOT NULL ,
	MALOAI nvarchar (15)  NOT NULL 
) 
GO

CREATE TABLE NHANVIEN (
	MANV nvarchar (15)  NOT NULL ,
	TEN nvarchar (15)  NULL ,
	DCHI nvarchar (50)  NULL ,
	DTHOAI nvarchar (15)  NULL ,
	LUONG float NULL ,
	LOAINV bit NULL 
) 
GO

ALTER TABLE PHANCONG  ADD 
	CONSTRAINT PK_PHANCONG PRIMARY KEY   
	(
		MANV,
		NGAYDI,
		MACB
	)   
GO

ALTER TABLE CHUYENBAY  ADD 
	CONSTRAINT PK_CHUYENBAY PRIMARY KEY   
	(
		MACB
	)   
GO

ALTER TABLE KHACHHANG  ADD 
	CONSTRAINT PK_KHACHHANG PRIMARY KEY   
	(
		MAKH
	)   
GO

ALTER TABLE DATCHO  ADD 
	CONSTRAINT PK_DATCHO PRIMARY KEY   
	(
		MAKH,
		NGAYDI,
		MACB
	)   
GO

ALTER TABLE KHANANG  ADD 
	CONSTRAINT PK_KHANANG PRIMARY KEY   
	(
		MANV,
		MALOAI
	)   
GO

ALTER TABLE LICHBAY  ADD 
	CONSTRAINT PK_LICHBAY PRIMARY KEY   
	(
		NGAYDI,
		MACB
	)   
GO

ALTER TABLE LOAIMB  ADD 
	CONSTRAINT PK_LOAIMB PRIMARY KEY   
	(
		MALOAI
	)   
GO

ALTER TABLE MAYBAY  ADD 
	CONSTRAINT PK_MAYBAY PRIMARY KEY   
	(
		SOHIEU,
		MALOAI
	)   
GO

ALTER TABLE NHANVIEN  ADD 
	CONSTRAINT PK_NHANVIEN PRIMARY KEY   
	(
		MANV
	)   
GO

ALTER TABLE PHANCONG ADD 
	CONSTRAINT FK_PHANCONG_LICHBAY FOREIGN KEY 
	(
		NGAYDI,
		MACB
	) REFERENCES LICHBAY (
		NGAYDI,
		MACB
	),
	CONSTRAINT FK_PHANCONG_NHANVIEN FOREIGN KEY 
	(
		MANV
	) REFERENCES NHANVIEN (
		MANV
	)
GO

ALTER TABLE DATCHO ADD 
	CONSTRAINT FK_DATCHO_KHACHHANG FOREIGN KEY 
	(
		MAKH
	) REFERENCES KHACHHANG (
		MAKH
	),
	CONSTRAINT FK_DATCHO_LICHBAY FOREIGN KEY 
	(
		NGAYDI,
		MACB
	) REFERENCES LICHBAY (
		NGAYDI,
		MACB
	)
GO

ALTER TABLE KHANANG ADD 
	CONSTRAINT FK_KHANANG_LOAIMB FOREIGN KEY 
	(
		MALOAI
	) REFERENCES LOAIMB (
		MALOAI
	),
	CONSTRAINT FK_KHANANG_NHANVIEN FOREIGN KEY 
	(
		MANV
	) REFERENCES NHANVIEN (
		MANV
	)
GO

ALTER TABLE LICHBAY ADD 
	CONSTRAINT FK_LICHBAY_CHUYENBAY FOREIGN KEY 
	(
		MACB
	) REFERENCES CHUYENBAY (
		MACB
	),
	CONSTRAINT FK_LICHBAY_MAYBAY FOREIGN KEY 
	(
		SOHIEU,
		MALOAI
	) REFERENCES MAYBAY (
		SOHIEU,
		MALOAI
	)
GO

ALTER TABLE MAYBAY ADD 
	CONSTRAINT FK_MAYBAY_LOAIMB FOREIGN KEY 
	(
		MALOAI
	) REFERENCES LOAIMB (
		MALOAI
	)
GO


INSERT INTO KHACHHANG
VALUES ('0101','Anh','567 Tran Phu','8826729')
INSERT INTO KHACHHANG
VALUES ('0009','Nga','223 Nguyen Trai','8932320')
INSERT INTO KHACHHANG
VALUES ('0045','Thu','285 Le Loi','8932203')
INSERT INTO KHACHHANG
VALUES ('0012','Ha','435 Quang Trung','8933232')
INSERT INTO KHACHHANG
VALUES ('0238','Hung','456 Pasteur','9812101')
INSERT INTO KHACHHANG
VALUES ('0397','Huong','234 Le van Sy','8952943')
INSERT INTO KHACHHANG
VALUES ('0582','Mai','789 Nguyen Du','')
INSERT INTO KHACHHANG
VALUES ('0934','Minh','678 Le Lai','')
INSERT INTO KHACHHANG
VALUES ('0091','Hai','345 Hung Vuong','8893223')
INSERT INTO KHACHHANG
VALUES ('0314','Phuong','395 Vo van Tan','8232320')
INSERT INTO KHACHHANG
VALUES ('0613','Vu','348 CMT8','8343232')
INSERT INTO KHACHHANG
VALUES ('0586','Son','123 Bach Dang','8556223')
INSERT INTO KHACHHANG
VALUES ('0422','Tien','75 Nguyen Thong','8332222')
GO

INSERT INTO NHANVIEN
VALUES ('1001','Huong','8 Dien Bien Phu','8330733',50000,1)
INSERT INTO NHANVIEN
VALUES ('1002','Phong','1 Ly Thuong Kiet', '8308117',45000,1)
INSERT INTO NHANVIEN
VALUES ('1003','Quang','78 Truong Dinh', '8234461',35000,1)
INSERT INTO NHANVIEN
VALUES ('1004','Phuong','351 Lac Long Quan', '8308155',25000,0)
INSERT INTO NHANVIEN
VALUES ('1005','Giao','65 Nguyen Thai Son','8324467',5000000,0)
INSERT INTO NHANVIEN
VALUES ('1006','Chi','12/6 Nguyen Kiem','8120012',150000,0)
INSERT INTO NHANVIEN
VALUES ('1007','Tam','36 Nguyen Van Cu', '8458188',500000,0)
GO

INSERT INTO CHUYENBAY
VALUES ('100','SLC','BOS','08:00','17:50')
INSERT INTO CHUYENBAY
VALUES ('112','DCA','DEN','14:00','18:07')
INSERT INTO CHUYENBAY
VALUES ('121','STL','SLC','07:00','09:13')
INSERT INTO CHUYENBAY
VALUES ('122','STL','YYV','08:03','10:19')
INSERT INTO CHUYENBAY
VALUES ('206','DFW','STL','09:00','11:40')
INSERT INTO CHUYENBAY
VALUES ('330','JFK','YYV','16:00','18:53')
INSERT INTO CHUYENBAY
VALUES ('334','ORD','MIA','12:00','14:14')
INSERT INTO CHUYENBAY
VALUES ('335','MIA','ORD','15:00','17:14')
INSERT INTO CHUYENBAY
VALUES ('336','ORD','MIA','18:00','20:14')
INSERT INTO CHUYENBAY
VALUES ('337','MIA','ORD','20:30','23:53')
INSERT INTO CHUYENBAY
VALUES ('394','DFW','MIA','19:00','21:30')
INSERT INTO CHUYENBAY
VALUES ('395','MIA','DFW','21:00','23:43')
INSERT INTO CHUYENBAY
VALUES ('449','CDG','DEN','10:00','19:29')
INSERT INTO CHUYENBAY
VALUES ('930','YYV','DCA','13:00','16:10')
INSERT INTO CHUYENBAY
VALUES ('931','DCA','YYV','17:00','18:10')
INSERT INTO CHUYENBAY
VALUES ('932','DCA','YYV','18:00','19:10')
INSERT INTO CHUYENBAY
VALUES ('991','BOS','ORD','17:00','18:22')
GO

INSERT INTO LOAIMB
VALUES ('Airbus','A310')
INSERT INTO LOAIMB
VALUES ('Airbus','A320')
INSERT INTO LOAIMB
VALUES ('Airbus','A330')
INSERT INTO LOAIMB
VALUES ('Airbus','A340')
INSERT INTO LOAIMB
VALUES ('Boeing','B727')
INSERT INTO LOAIMB
VALUES ('Boeing','B747')
INSERT INTO LOAIMB
VALUES ('Boeing','B757')
INSERT INTO LOAIMB
VALUES ('MD','DC10')
INSERT INTO LOAIMB
VALUES ('MD','DC9')
GO

INSERT INTO MAYBAY
VALUES (10,'B747')
INSERT INTO MAYBAY
VALUES (11,'B727')
INSERT INTO MAYBAY
VALUES (13,'B727')
INSERT INTO MAYBAY
VALUES (13,'B747')
INSERT INTO MAYBAY
VALUES (21,'DC10')
INSERT INTO MAYBAY
VALUES (21,'DC9')
INSERT INTO MAYBAY
VALUES (22,'B757')
INSERT INTO MAYBAY
VALUES (22,'DC9')
INSERT INTO MAYBAY
VALUES (23,'DC9')
INSERT INTO MAYBAY
VALUES (24,'DC9')
INSERT INTO MAYBAY
VALUES (70,'A310')
INSERT INTO MAYBAY
VALUES (80,'A320')
INSERT INTO MAYBAY
VALUES (93,'B757')
GO

INSERT INTO KHANANG
VALUES ('1001','B727')
INSERT INTO KHANANG
VALUES ('1001','B747')
INSERT INTO KHANANG
VALUES ('1001','DC10')
INSERT INTO KHANANG
VALUES ('1002','A320')
INSERT INTO KHANANG
VALUES ('1002','A340')
INSERT INTO KHANANG
VALUES ('1002','B757')
INSERT INTO KHANANG
VALUES ('1002','DC9')
INSERT INTO KHANANG
VALUES ('1003','A310')
INSERT INTO KHANANG
VALUES ('1003','DC9')
GO

INSERT INTO LICHBAY
VALUES ('2000-10-31','100',10,'B747')
INSERT INTO LICHBAY
VALUES ('2000-10-31','112',11,'B727')
INSERT INTO LICHBAY
VALUES ('2000-10-31','206',13,'B727')
INSERT INTO LICHBAY
VALUES ('2000-10-31','334',10 ,'B747')
INSERT INTO LICHBAY
VALUES ('2000-10-31','335',10,'B747')
INSERT INTO LICHBAY
VALUES ('2000-10-31','337',24,'DC9')
INSERT INTO LICHBAY
VALUES ('2000-10-31','449',70,'A310')
INSERT INTO LICHBAY
VALUES ('2000-11-01','100',80,'A320')
INSERT INTO LICHBAY
VALUES ('2000-11-01','112',21,'DC10')
INSERT INTO LICHBAY
VALUES ('2000-11-01','206',22,'DC9')
INSERT INTO LICHBAY
VALUES ('2000-11-01','334',10,'B747')
INSERT INTO LICHBAY
VALUES ('2000-11-01','337',10,'B747')
INSERT INTO LICHBAY
VALUES ('2000-11-01','395',23,'DC9')
INSERT INTO LICHBAY
VALUES ('2000-11-01','991',22,'B757')
GO

INSERT INTO PHANCONG
VALUES ('1001','2000-10-31','100')
INSERT INTO PHANCONG
VALUES ('1001','2000-11-01','100')
INSERT INTO PHANCONG
VALUES ('1002','2000-10-31','100')
INSERT INTO PHANCONG
VALUES ('1002','2000-11-01','100')
INSERT INTO PHANCONG
VALUES ('1003','2000-10-31','100')
INSERT INTO PHANCONG
VALUES ('1003','2000-10-31','337')
INSERT INTO PHANCONG
VALUES ('1004','2000-10-31','100')
INSERT INTO PHANCONG
VALUES ('1004','2000-10-31','337')
INSERT INTO PHANCONG
VALUES ('1005','2000-10-31','337')
INSERT INTO PHANCONG
VALUES ('1006','2000-10-31','337')
INSERT INTO PHANCONG
VALUES ('1006','2000-11-01','991')
INSERT INTO PHANCONG
VALUES ('1007','2000-10-31','206')
INSERT INTO PHANCONG
VALUES ('1007','2000-11-01','112')
INSERT INTO PHANCONG
VALUES ('1007','2000-11-01','991')
GO

INSERT INTO DATCHO
VALUES ('0009','2000-10-31','449')
INSERT INTO DATCHO
VALUES ('0009','2000-11-01','100')
INSERT INTO DATCHO
VALUES ('0045','2000-11-01','991')
INSERT INTO DATCHO
VALUES ('0012','2000-10-31','206')
INSERT INTO DATCHO
VALUES ('0238','2000-10-31','334')
INSERT INTO DATCHO
VALUES ('0582','2000-11-01','991')
INSERT INTO DATCHO
VALUES ('0091','2000-11-01','100')
INSERT INTO DATCHO
VALUES ('0314','2000-10-31','449')
INSERT INTO DATCHO
VALUES ('0613','2000-11-01','100')
INSERT INTO DATCHO
VALUES ('0586','2000-10-31','100')
INSERT INTO DATCHO
VALUES ('0586','2000-11-01','991')
INSERT INTO DATCHO
VALUES ('0422','2000-10-31','449')
GO

--TRUY VẤN ĐƠN GIẢN
--Q1
SELECT PC.MANV, PC.TEN, PC.DCHI, PC.DTHOAI
FROM NHANVIEN PC JOIN KHANANG KN ON PC.MANV = KN.MANV
WHERE KN.MALOAI = 'B747'

--Q2
SELECT DISTINCT CB.MACB, NGAYDI
FROM LICHBAY LB RIGHT JOIN CHUYENBAY CB ON LB.MACB = CB.MACB
WHERE CB.SBDI = 'DCA'
AND CONVERT(TIME, CB.GIODI) BETWEEN '14:00' AND '18:00'

select* from CHUYENBAY

--Q3
SELECT DISTINCT NV.TEN
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
				JOIN CHUYENBAY CB ON CB.MACB = PC.MACB
WHERE PC.MACB = '100' AND CB.SBDI = 'SLC'

--Q4
SELECT DISTINCT MB.MALOAI, MB.SOHIEU
FROM MAYBAY MB JOIN LICHBAY LB ON MB.MALOAI = LB.MALOAI
				JOIN CHUYENBAY CB ON CB.MACB = LB.MACB
WHERE CB.SBDI = 'MIA'

--Q5
SELECT LB.MACB, LB.NGAYDI, KH.TEN, KH.DCHI, KH.DTHOAI
FROM LICHBAY LB JOIN DATCHO DC ON LB.MACB = DC.MACB
				JOIN KHACHHANG KH ON KH.MAKH = DC.MAKH
ORDER BY LB.MACB ASC, LB.NGAYDI DESC

--Q6
SELECT DISTINCT LB.MACB, LB.NGAYDI, NV.TEN, NV.DCHI, NV.DTHOAI
FROM LICHBAY LB JOIN PHANCONG PC ON LB.MACB = PC.MACB
				JOIN NHANVIEN NV ON NV.MANV = PC.MANV
ORDER BY LB.MACB ASC, LB.NGAYDI DESC

--Q7
SELECT CB.MACB, PC.NGAYDI, NV.TEN, NV.MANV
FROM CHUYENBAY CB JOIN PHANCONG PC ON CB.MACB = PC.MACB
				JOIN NHANVIEN NV ON NV.MANV = PC.MANV
WHERE CB.SBDEN = 'ORD'

--Q8
SELECT CB.MACB, PC.NGAYDI, NV.TEN
FROM CHUYENBAY CB JOIN PHANCONG PC ON CB.MACB = PC.MACB
				JOIN NHANVIEN NV ON NV.MANV = PC.MANV
WHERE NV.MANV = '1001'

--Q9
SELECT CB.MACB, CB.SBDI, CB.GIODI, CB.GIODEN, PC.NGAYDI
FROM CHUYENBAY CB JOIN PHANCONG PC ON CB.MACB = PC.MACB
WHERE CB.SBDEN = 'DEN'
ORDER BY PC.NGAYDI DESC, CB.SBDI ASC

--Q10
SELECT NV.TEN, LMB.HANGSX, LMB.MALOAI
FROM NHANVIEN NV JOIN KHANANG KN ON NV.MANV = KN.MANV
				JOIN LOAIMB LMB ON LMB.MALOAI = KN.MALOAI

--Q11
SELECT CB.MACB, NV.MANV, NV.TEN
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
				JOIN CHUYENBAY CB ON CB.MACB = PC.MACB
WHERE CB.MACB = '100' AND PC.NGAYDI = '2000-11-01'

--Q12
SELECT NV.MANV, NV.TEN
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
				JOIN CHUYENBAY CB ON CB.MACB = PC.MACB
WHERE PC.NGAYDI = '2000-31-10' AND CB.SBDI = 'MIA' AND CB.GIODI = '20:30'

--Q13
SELECT LB.MACB, MB.SOHIEU, LMB.MALOAI, LMB.HANGSX, NV.TEN
FROM LICHBAY LB JOIN LOAIMB LMB ON LB.MALOAI = LMB.MALOAI
				JOIN MAYBAY MB ON LMB.MALOAI = MB.MALOAI
				JOIN PHANCONG PC ON PC.MACB = LB.MACB
				JOIN NHANVIEN NV ON NV.MANV = PC.MANV
WHERE NV.TEN LIKE '%Quang'

--Q14: CẦN CHECK
SELECT NV.TEN, PC.MACB
FROM NHANVIEN NV LEFT JOIN PHANCONG PC ON NV.MANV = PC.MANV
WHERE PC.MACB IS NULL

--Q15
SELECT DISTINCT KH.TEN
FROM DATCHO DC JOIN KHACHHANG KH ON DC.MAKH = KH.MAKH
			   JOIN LICHBAY LB ON DC.MACB = LB.MACB
			   JOIN LOAIMB LMB ON LMB.MALOAI = LB.MALOAI
WHERE LMB.HANGSX = 'Boeing'

--Q16: DISTINCT VÌ CHỈ YC TÌM MACB THỎA DK, CÓ 2 MÃ 334 DÙ KHÁC NGÀY (TỨC LÀ KO TRÙNG) NHƯNG CHỈ CẦN LẤY 1 GIÁ TRỊ
SELECT DISTINCT LB.MACB 
FROM LICHBAY LB WHERE LB.SOHIEU = 10 AND LB.MALOAI = 'B747'

--TRUY VẤN HÀM KẾT HỢP
--Q17
SELECT CB.SBDEN, COUNT(CB.MACB)  'SL'
FROM CHUYENBAY CB
GROUP BY CB.SBDEN ORDER BY CB.SBDEN ASC

--Q18
SELECT CB.SBDI, COUNT(CB.MACB)  'SL'
FROM CHUYENBAY CB
GROUP BY CB.SBDI ORDER BY CB.SBDI ASC

--Q19
SELECT CB.SBDI, LB.NGAYDI, COUNT(CB.MACB) 'SL'
FROM CHUYENBAY CB JOIN LICHBAY LB ON CB.MACB = LB.MACB
GROUP BY CB.SBDI, LB.NGAYDI 

--Q20
SELECT CB.SBDEN, LB.NGAYDI, COUNT(LB.MACB) 'SL'
FROM CHUYENBAY CB JOIN LICHBAY LB ON LB.MACB = CB.MACB
GROUP BY LB.NGAYDI, CB.SBDEN

--Q21: VỚI MỖI LỊCH BAY, CHO BẾT MÃ CB, NGÀY ĐI VÀ SLNV KO PHẢI PHI CÔNG CHUYẾN ĐÓ
SELECT LB.MACB, LB.NGAYDI, COUNT(NV.MANV) 'SL'
FROM LICHBAY LB JOIN PHANCONG PC ON LB.MACB = PC.MACB
				JOIN NHANVIEN NV ON NV.MANV = PC.MANV
WHERE NV.LOAINV = 1
GROUP BY LB.MACB, LB.NGAYDI
--SUS

--Q22
SELECT CB.SBDI, COUNT(LB.MACB) 'SL'
FROM LICHBAY LB JOIN CHUYENBAY CB ON LB.MACB = CB.MACB
WHERE CB.SBDI = 'MIA' AND LB.NGAYDI = '2000-11-01'
GROUP BY CB.SBDI

--Q23
SELECT CB.MACB, PC.NGAYDI, COUNT(NV.MANV) 'SL'
FROM CHUYENBAY CB JOIN PHANCONG PC ON CB.MACB = PC.MACB
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
GROUP BY CB.MACB, PC.NGAYDI
ORDER BY COUNT(NV.MANV) DESC

SELECT PC.MACB, PC.NGAYDI, COUNT(NV.MANV) 'SL'
FROM PHANCONG PC 
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
GROUP BY PC.MACB, PC.NGAYDI
ORDER BY COUNT(NV.MANV) DESC
--NHƯ NHAU VÌ CÓ TH CÓ CHUYẾN BAY MÀ 0 CÓ PHÂN CÔNG THÌ CHỈ CẦN ƯU TIÊN PC

--Q24
SELECT LB.MACB, LB.NGAYDI, COUNT(DC.MAKH) 'SL'
FROM LICHBAY LB JOIN DATCHO DC ON DC.MACB = LB.MACB
GROUP BY LB.MACB, LB.NGAYDI
ORDER BY COUNT(DC.MAKH) DESC

--Q25
SELECT PC.MACB, PC.NGAYDI, SUM(NV.LUONG) 'LUONG'
FROM PHANCONG PC 
JOIN NHANVIEN NV ON PC.MANV = NV.MANV
GROUP BY PC.MACB, PC.NGAYDI
ORDER BY COUNT(NV.LUONG) ASC

--Q26
SELECT NV.MANV, AVG(NV.LUONG) 'LUONG TB'
FROM NHANVIEN NV WHERE NV.LOAINV = 1
GROUP BY NV.MANV

--Q27
SELECT NV.MANV, AVG(NV.LUONG) 'LUONG TB'
FROM NHANVIEN NV WHERE NV.LOAINV = 0
GROUP BY NV.MANV

--Q28
SELECT LMB.MALOAI, COUNT(CB.MACB) 'SLCB'
FROM LOAIMB LMB JOIN LICHBAY LB ON LMB.MALOAI = LB.MALOAI
JOIN CHUYENBAY CB ON CB.MACB = LB.MACB
WHERE CB.SBDEN = 'ORD' 
GROUP BY LMB.MALOAI

--Q29
SELECT CB.SBDI, COUNT(CB.MACB) 'SL'
FROM CHUYENBAY CB 
WHERE CONVERT(TIME, CB.GIODI) BETWEEN '10:00' AND '22:00'
GROUP BY CB.SBDI 
HAVING COUNT(CB.MACB) > 2

--Q30: 0 CẦN JOIN THÊM BẢNG PHÂN CÔNG NỮA
SELECT DISTINCT NV.TEN, PC.NGAYDI, COUNT(PC.MACB) 'SLCB'
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY NV.TEN, PC.NGAYDI
HAVING COUNT(PC.MACB) >= 2

SELECT NV.TEN, PC.NGAYDI, PC.MACB
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV

--Q31
SELECT LB.MACB, LB.NGAYDI, COUNT(DC.MAKH) 'SLKH'
FROM LICHBAY LB JOIN DATCHO DC ON LB.MACB = DC.MACB
GROUP BY LB.MACB, LB.NGAYDI
HAVING COUNT(DC.MAKH) < 3

--Q32
SELECT NV.MANV, MB.SOHIEU, MB.MALOAI, COUNT(PC.MACB) 'SLCB' 
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
				 JOIN LICHBAY LB ON LB.MACB = PC.MACB
				 JOIN MAYBAY MB ON MB.MALOAI = LB.MALOAI
WHERE NV.MANV = '1001'
GROUP BY NV.MANV, MB.SOHIEU, MB.MALOAI
HAVING COUNT(PC.MACB) >= 2
--KHÚC SELECT CÓ HAY KHÔNG CÁI COUNT CŨNG DC, VẪN HAVING ĐƯỢC

--Q33
SELECT* FROM LOAIMB
SELECT LMB.HANGSX, COUNT(LMB.MALOAI) 'SLMB'
FROM LOAIMB LMB GROUP BY LMB.HANGSX


--w5 truy van long
--Q34
SELECT DISTINCT LMB.HANGSX, LMB.MALOAI, MB.SOHIEU
FROM MAYBAY MB JOIN LOAIMB LMB ON MB.MALOAI = LMB.MALOAI 
			   JOIN LICHBAY LB ON LB.MALOAI = MB.MALOAI
GROUP BY LMB.HANGSX, LMB.MALOAI, MB.SOHIEU
HAVING COUNT (*) >= ALL (
SELECT COUNT(*)
FROM MAYBAY MB JOIN LOAIMB LMB ON MB.MALOAI = LMB.MALOAI
	 JOIN LICHBAY LB ON LB.MALOAI = MB.MALOAI
GROUP BY LMB.HANGSX, LMB.MALOAI, MB.SOHIEU
)

SELECT * FROM MAYBAY
SELECT * FROM LOAIMB
SELECT * FROM MAYBAY MB JOIN LOAIMB LMB ON MB.MALOAI = LMB.MALOAI

--Q35
SELECT NV.TEN, COUNT(*)
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY NV.TEN
HAVING COUNT(*) >= ALL(
SELECT COUNT(*)
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY NV.TEN
)

--Q36
SELECT NV.TEN, NV.DCHI, NV.DTHOAI
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
				 JOIN CHUYENBAY CB ON CB.MACB = PC.MACB
GROUP BY NV.TEN, NV.DCHI, NV.DTHOAI
HAVING COUNT(*) >= ALL(
SELECT COUNT(*)
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
				 JOIN CHUYENBAY CB ON CB.MACB = PC.MACB
				 GROUP BY NV.TEN, NV.DCHI, NV.DTHOAI
)

--Q37
SELECT CB.SBDEN, COUNT(*) 'SL'
FROM CHUYENBAY CB 
GROUP BY CB.SBDEN
HAVING COUNT(*) <= ALL(
SELECT COUNT(*)
FROM CHUYENBAY CB GROUP BY CB.SBDEN)

SELECT SBDEN, COUNT(*) FROM CHUYENBAY GROUP BY SBDEN

--Q38
SELECT CB.SBDI, COUNT(*) 'SL'
FROM CHUYENBAY CB 
GROUP BY CB.SBDI
HAVING COUNT(*) >= ALL(
SELECT COUNT(*)
FROM CHUYENBAY CB GROUP BY CB.SBDI)

--Q39
SELECT KH.TEN, KH.DCHI, KH.DTHOAI, COUNT(*) 'SL'
FROM KHACHHANG KH JOIN DATCHO DC ON KH.MAKH = DC.MAKH
GROUP BY KH.MAKH, KH.TEN, KH.DCHI, KH.DTHOAI
HAVING COUNT(*) >= ALL(
SELECT COUNT(*)
FROM KHACHHANG KH JOIN DATCHO DC ON KH.MAKH = DC.MAKH
GROUP BY KH.MAKH, KH.TEN, KH.DCHI, KH.DTHOAI
)

--Q40
SELECT NV.MANV, NV.TEN, NV.LUONG, COUNT(KN.MALOAI) 'SLL'
FROM NHANVIEN NV JOIN KHANANG KN ON NV.MANV = KN.MANV
GROUP BY NV.MANV, NV.TEN, NV.LUONG
HAVING COUNT(KN.MALOAI) >= ALL(
SELECT COUNT(KN.MALOAI)
FROM NHANVIEN NV JOIN KHANANG KN ON NV.MANV = KN.MANV
GROUP BY NV.MANV, NV.TEN, NV.LUONG)

--Q41
SELECT NV.MANV, NV.TEN, NV.LUONG
FROM NHANVIEN NV WHERE NV.LUONG >= ALL (SELECT LUONG FROM NHANVIEN)

--Q42
SELECT DISTINCT NV.MANV, NV.TEN, NV.LUONG, PC.MACB, PC.NGAYDI
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV,
	 NHANVIEN NV2 JOIN PHANCONG PC2 ON NV2.MANV = PC2.MANV
WHERE PC.MACB = PC2.MACB AND PC.NGAYDI = PC2.NGAYDI AND NV.LUONG >= NV2.LUONG
ORDER BY PC.NGAYDI ASC

SELECT * FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
--SAI

--Q43
SELECT CB.MACB, CB.GIODI, CB.GIODEN FROM CHUYENBAY CB
WHERE CB.GIODI <= ALL (SELECT GIODI FROM CHUYENBAY)

--Q44
SELECT CB.MACB, (GIODEN - GIODI) 'TG' FROM CHUYENBAY CB
WHERE GIODEN - GIODI >= ALL (SELECT (GIODEN - GIODI) FROM CHUYENBAY)

--Q45
SELECT CB.MACB, CB.GIODI, CB.GIODEN, (GIODEN - GIODI) 'TG' FROM CHUYENBAY CB
WHERE GIODEN - GIODI <= ALL (SELECT (GIODEN - GIODI) FROM CHUYENBAY)

--Q46
SELECT CB.MACB, LB.NGAYDI
FROM CHUYENBAY CB JOIN LICHBAY LB ON CB.MACB = LB.MACB
WHERE LB.MALOAI = 'B747'
GROUP BY CB.MACB, LB.NGAYDI
HAVING COUNT(CB.MACB) >= ALL(
SELECT COUNT(CB.MACB)
FROM CHUYENBAY CB JOIN LICHBAY LB ON CB.MACB = LB.MACB
WHERE LB.MALOAI = 'B747'
GROUP BY CB.MACB, LB.NGAYDI
)
--SUS

--Q47
SELECT CB.MACB, COUNT(NV.MANV) 'SLNV'
FROM CHUYENBAY CB JOIN PHANCONG PC ON CB.MACB = PC.MACB
				  JOIN NHANVIEN NV ON NV.MANV = PC.MANV
				  JOIN DATCHO DC ON DC.MACB = CB.MACB
GROUP BY CB.MACB, PC.NGAYDI
HAVING COUNT(DC.MAKH) > 3

--Q48
SELECT LOAINV, COUNT(MANV) 'SLNV'
FROM NHANVIEN
GROUP BY LOAINV
HAVING SUM(LUONG) > 600000

--Q49
SELECT CB.MACB, COUNT(DC.MAKH) 'SLKH'
FROM CHUYENBAY CB JOIN PHANCONG PC ON CB.MACB = PC.MACB
				  JOIN NHANVIEN NV ON NV.MANV = PC.MANV
				  JOIN DATCHO DC ON DC.MACB = CB.MACB
GROUP BY CB.MACB, PC.NGAYDI
HAVING COUNT(NV.MANV) > 3
--SUS

--Q50
SELECT MALOAI, COUNT(MACB) 'SLCB'
FROM LICHBAY
GROUP BY MALOAI 
HAVING COUNT(MALOAI) > 1

--Q51
SELECT T.MACB
FROM CHUYENBAY T
WHERE NOT EXISTS (
SELECT S.MACB
FROM LICHBAY S JOIN LOAIMB MB ON S.MALOAI = MB.MALOAI
WHERE MB.HANGSX = 'Boeing'
EXCEPT(
SELECT R.MACB
FROM CHUYENBAY R 
WHERE R.MACB = T.MACB))

--Q52
SELECT T.MANV, T.TEN
FROM NHANVIEN T
WHERE NOT EXISTS(
SELECT S.MALOAI
FROM LOAIMB S 
WHERE S.HANGSX = 'Airbus'
EXCEPT(
SELECT R.MALOAI
FROM KHANANG R
WHERE R.MANV = T.MANV))

--Q53
SELECT T.MANV, T.TEN
FROM NHANVIEN T
WHERE T.LOAINV = 0 AND NOT EXISTS(
SELECT S.MACB
FROM CHUYENBAY S 
WHERE S.MACB = '100'
EXCEPT(
SELECT R.MACB
FROM PHANCONG R
WHERE R.MANV = T.MANV))

--Q54
SELECT T.NGAYDI
FROM LICHBAY T
WHERE NOT EXISTS(
SELECT S.MALOAI
FROM LOAIMB S
WHERE S.HANGSX = 'Boeing'
EXCEPT(
SELECT R.MACB
FROM CHUYENBAY R
WHERE R.MACB = T.MACB
))

--Q55
SELECT T.MALOAI
FROM LOAIMB T
WHERE T.HANGSX = 'Boeing' AND NOT EXISTS(
SELECT S.NGAYDI
FROM LICHBAY S
EXCEPT(
SELECT R.NGAYDI
FROM LICHBAY R
WHERE R.MALOAI = T.MALOAI)) 

--Q56: SAI
SELECT T.MAKH, T.TEN
FROM KHACHHANG T
WHERE NOT EXISTS(
SELECT S.MAKH
FROM DATCHO S
WHERE S.NGAYDI <= '2000-10-31' AND S.NGAYDI >= '2000-1-1'
EXCEPT(
SELECT R.MAKH
FROM DATCHO R
WHERE R.MAKH = T.MAKH))

--Q57
SELECT T.MANV, T.TEN
FROM NHANVIEN T
WHERE EXISTS(
SELECT S.MALOAI
FROM LOAIMB S 
WHERE S.HANGSX = 'Airbus'
EXCEPT(
SELECT R.MALOAI
FROM KHANANG R
WHERE R.MANV = T.MANV))

--Q58
SELECT T.SBDI
FROM CHUYENBAY T
WHERE NOT EXISTS(
SELECT S.MACB
FROM CHUYENBAY S JOIN LICHBAY LB ON S.MACB = LB.MACB
				 JOIN LOAIMB LMB ON LB.MALOAI = LMB.MALOAI
WHERE LMB.HANGSX = 'Boeing'
EXCEPT(
SELECT R.MACB
FROM LICHBAY R
WHERE R.MACB = T.MACB))

--W7: ALPHABET
--A
SELECT LOAINV, LUONG, COUNT(*) 'SL'
FROM NHANVIEN 
GROUP BY LOAINV, LUONG WITH CUBE

--B
SELECT MACB, NGAYDI, COUNT(*) 'SL'
FROM LICHBAY
WHERE MALOAI = 'B747' OR MALOAI = 'B727'
GROUP BY NGAYDI, MACB WITH ROLLUP

--C: COMPUTE
--D: SUS
SELECT KH.TEN, KH.MAKH, COUNT (*)
FROM KHACHHANG KH JOIN DATCHO DC ON KH.MAKH = DC.MAKH
GROUP BY KH.MAKH, KH.TEN WITH ROLLUP

--E, F: COMPUTE

--G: SUS
SELECT PC.MACB, PC.NGAYDI, COUNT(*)
FROM PHANCONG PC
GROUP BY PC.MACB, PC.NGAYDI WITH CUBE

--H
SELECT CB.SBDI, CB.SBDEN, COUNT(*)
FROM CHUYENBAY CB
GROUP BY CB.SBDI, CB.SBDEN WITH CUBE

--I
SELECT CB.GIODI, CB.GIODEN, COUNT(*)
FROM CHUYENBAY CB
GROUP BY CB.GIODI, CB.GIODEN WITH CUBE

--J
SELECT MANV, TEN, (CASE LOAINV 
				   WHEN 0 THEN LUONG * 0.1
				   WHEN 1 THEN LUONG * 0.15
				   END) AS PHUCAP	
FROM NHANVIEN 

--K
SELECT NV.MANV, NV.TEN, COUNT(*) 'SLPC'
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY NV.MANV, NV.TEN

--L
SELECT NV.MANV, NV.TEN, COUNT(*) 'SLMB'
FROM NHANVIEN NV JOIN KHANANG KN ON NV.MANV = KN.MANV
GROUP BY NV.MANV, NV.TEN

--M
SELECT KN.MALOAI, COUNT(*) 'SLPC'
FROM KHANANG KN JOIN NHANVIEN NV ON KN.MANV = NV.MANV
GROUP BY KN.MALOAI

--N
SELECT MB.MALOAI, MB.SOHIEU, COUNT(*) 'SL'
FROM MAYBAY MB JOIN LICHBAY LB ON MB.MALOAI = LB.MALOAI AND MB.SOHIEU = LB.SOHIEU
GROUP BY MB.MALOAI, MB.SOHIEU

--O
SELECT CB.SBDI, COUNT(CB.MACB) 'SLCB'
FROM CHUYENBAY CB JOIN LICHBAY LB ON LB.MACB = CB.MACB
WHERE LB.NGAYDI = '2000-11-1'
GROUP BY CB.SBDI

--P
SELECT KH.MAKH, KH.TEN, COUNT(*) 'SL'
FROM KHACHHANG KH JOIN DATCHO DC ON KH.MAKH = DC.MAKH
WHERE DC.MACB = '100'
GROUP BY KH.MAKH, KH.TEN

--Q
SELECT LB.NGAYDI, COUNT(*) AS SL
FROM LICHBAY LB JOIN LOAIMB L ON LB.MALOAI = L.MALOAI
WHERE L.HANGSX = 'Airbus'
GROUP BY LB.NGAYDI

--R
CREATE TABLE KHACHHANGTHUONGXUYEN
(
	MAKH NVARCHAR(15),
	TENKH NVARCHAR(15),
	SOLANDATCHO INT

	CONSTRAINT PK_KHTX PRIMARY KEY (MAKH)
	CONSTRAINT FK_KHTX_KH FOREIGN KEY (MAKH)
	REFERENCES KHACHHANG
)

INSERT INTO KHACHHANGTHUONGXUYEN(MAKH, TENKH)
SELECT MAKH, TEN FROM KHACHHANG
WHERE MAKH IN(
SELECT KH.MAKH
FROM KHACHHANG KH JOIN DATCHO DC ON KH.MAKH = DC.MAKH
GROUP BY KH.MAKH
HAVING COUNT(*) >= 2)

UPDATE KHACHHANGTHUONGXUYEN
SET SOLANDATCHO = (
SELECT COUNT(*) 
FROM KHACHHANG KH JOIN DATCHO DC ON KH.MAKH = DC.MAKH
WHERE KHACHHANGTHUONGXUYEN.MAKH = KH.MAKH
)

SELECT * FROM KHACHHANGTHUONGXUYEN

--S
ALTER TABLE KHACHHANGTHUONGXUYEN
ADD LOAIKH NVARCHAR(30)

UPDATE KHACHHANGTHUONGXUYEN
SET LOAIKH = (CASE 
WHEN SOLANDATCHO >= 2 AND SOLANDATCHO <= 4 THEN N'Thường xuyên'
WHEN SOLANDATCHO >= 5 AND SOLANDATCHO <= 7 THEN N'Thân thiết'
WHEN SOLANDATCHO >= 7 THEN N'VIP'
END)

SELECT * FROM KHACHHANGTHUONGXUYEN

SELECT * FROM LICHBAY
SELECT * FROM NHANVIEN
SELECT * FROM KHANANG
SELECT * FROM LOAIMB
SELECT * FROM PHANCONG
SELECT * FROM CHUYENBAY JOIN LICHBAY LB ON LB.MACB = CHUYENBAY.MACB 
SELECT * FROM DATCHO
